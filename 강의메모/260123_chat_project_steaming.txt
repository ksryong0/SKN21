강사님 왈 장고 교재 게시판 만들기 해보면 좋다고 하심.

res=model.invoke(질의)
{"response":res.content}

res=model.stream(질의)
for token in res:
	token

main->generator
	yield
일    <-
다시 -> 첫 yield 뒤부터 다음 yield까지 일함
반복

광명자동차유리복원 베스트원
글로벌자동차유리

mfa 디바이스 이름 : AWS-SKN21_ryong
인증 관리자 앱
다음
------------------------------
ssh:내가 원격의 컴퓨터를 컨트롤하기 위한 것.
서버는 ssh 서버가 돌아가고 있어야함
클라는 ssh 클라로 ssh 서버에 접속.
ssh는 주로 포트번호 22 사용.

인바운드 규칙 정한거 : 방화벽

아마존 aws ec2에서 public ip는 고정 아이피가 아니고 유동 아이피임.
------------------------------
ec2
연결 버튼 클릭
ec2인스턴스 연결 탭
연결버튼 클릭

터미널로 접속됨

처음 설치한 뒤
apt로 application을 설치하기 전에
터미널 명령

sudo apt update

sudo apt upgrade
y

cmd 열기
ssh-key 디렉토리로 이동
cd C:\Users\Playdata\Documents\ssh-key 

04.ipynb로 가서
SSH private key 파일 권한 설정
로 가서 그대로 따라하기

6번에 추가 누르고
고급 클릭
개체유형에서 사용자만 남기고 오케이
지금찾기 클릭
playdata(os설치할때 한 계정) 클릭
확인
확인
그럼 playdata만 등록됨
모든권한에 허용 체크하면 다 허용됨.

적용->확인

--------------------------------------
윈도우 cmd에서 접속하는 방법

ssh-key 디렉토리로 이동
위에서 cmd 눌러서 열기

퍼블릭 주소 복사
터미널에서
ssh -i my-server-sshkey.pem ubuntu@퍼블릭주소
ssh -i my-server-sshkey.pem ubuntu@15.165.76.99
ssh -i ryong.pem ubuntu@15.165.76.99
yes
할거 다했으면 exit 누르면 됨.

aws 사이트에서 네트워크 및 보안 밑에 탄력적 IP 클릭
탄력적 IP 주소 할당 클릭
할당 클릭

체크하고 위에 작업 누르고 탄력적 IP 주소 연결 클릭
인스턴스 선택하고 연결

VPC는 삭제 안해도 비용이 안나감

주말에 EC2 서버 생성을 해보고, 탄력적 IP 적용.
EC2 서버 생성했으면 apt update, apt upgrade, ssh연결
----------------------
private + public 키 페어
클라는 private를 저장.
서버는 public을 저장.
클라는 ssh로 키를 서버에 보내주면 서버가 검증해서 확인.

기존 key-pair 생성해둔거를 쓰면 다운로드는 안됨.
기존거 써도 됨.
-------------------
인바운드 보안 그룹규칙 
유형(protocol)

포트 범위
주피터랩(8888)
------------------
sudo가 파이썬 pip 같은거임.
우분투에는 파이썬3가 내장되어 있다.
------------우분투 명령어들--------
우분투 화면 클리어 명령어 : clear

현재 경로를 알려주는 명령어 : pwd
	/home/ubuntu
home : 사용자 계정들의 root 경로. 윈도우로 치면 c 밑에 users 디렉토리.
ubuntu: ubuntu라는 이름의 계정 디렉토리.

~:내 홈 디렉토리
~/.bashrc : /home/ubuntu/.bashrc
rc들어가는 파일들은 환경변수임.
.bash는 실행명령어.

cd ~

클라는 웹브라우저에 접근해서 개발. jupyterlab에 접속?
~는 내가 홈디렉토리에 있다는 의미.

mkdir : 디렉토리 생성
	mkdir 디렉토리이름
	mkdir test_jupyter

cd test_jupyter

git clone 장고프로젝트

가상환경만들기
uv venv .venv --python=3.12

가상환경 실행시는 source도 입력해야함
source .venv/bin/activate

jupyterlab 서버, 클라 다 설치
uv pip install jupyterlab

환경설정파일 생성
jupyter lab --generate-config

ipython을 실행
ipython

from jupyter_server.auth import passwd

passwd()
비밀번호 입력 및 확인

출력으로 나온거 복사(' 포함)
'argon2:$argon2id$v=19$m=10240,t=10,p=8$HUYoTr9PjQB4/M2ZcahE1g$OraPlMYRh4HvKeiUvAVKHFW0GaBifm5ehidvn+ryz+U'

exit() 입력

cd ~/.jupyter

ls -al : 현재 디렉토리 안에 있는 파일 확인

vi 대신 나노에디터를 쓸 거라고 함.

nano jupyter_lab_config.py

aws 인스턴스의 private 주소를
c.NotebookApp.ip 에 넣음
c.NotebookApp.password는 아까 복사한거 붙여넣기.

아래 세개를 복사해서 위에 연 파이썬 파일에서 c=get_config() 밑에 붙여넣기하고 들여쓰기 맞춰줌

c.NotebookApp.ip = '10.0.15.161'
c.NotebookApp.open_browser = False
c.NotebookApp.password = 'argon2:$argon2id$v=19$m=10240,t=10,p=8$HUYoTr9PjQB4/M2ZcahE1g$OraPlMYRh4HvKeiUvAVKHFW0GaBifm5ehidvn+ryz+U'

컨트롤 + s 누르고, 컨트롤 + x 누름.

cd ~/test_jupyter/
jupyter lab --ip 0.0.0.0

인스턴스의 public ip의 8888 포트로 접속
3.37.227.19:8888

password입력해서 접속
ipykernel 클릭하면 vscode에서처럼 쓸수 있음. 저장해두면 껐다 켜도 유지되어 있음.

주피터랩은 포트번호가 8888임.

끌 때는 컨트롤+c 누르면 됨.

vscode의 extension에서 remote-ssh 설치

왼쪽 아래 >< 요런 아이콘 클릭
connect to host... 선택
ssh 호스트 구성... 클릭
사용자\.ssh\config 파일 선택

Host EC2-mypoll_server
    HostName 3.37.227.19
    User ubuntu
    IdentityFile C:\Users\Playdata\Documents\ssh-key\mypoll-key.pem
입력.

HostName은 인스턴스의 Public IP주소.
User는 ubuntu 입력.
IdentityFile pem파일이 저장된 경로 입력

다시 왼쪽 아래 >< 누르고
connect to host 누르고
이름 지정한거 클릭

컨트롤 + j누르면 우분투 뜸.
ec2거 폴더 연 거임.

python extension 설치

---------------------------------------------------
수업자료\mypoll_chat 복사

django 프로젝트
wsgi?


로컬    			EC2
장고프로젝트	->	운영은 EC2 서버에서 하고 싶음.
장고프로젝트를 깃허브에 push.
		     이 깃허브를 ec2에 클론.
		     ec2에도 로컬 레포지토리가 생김.

ssh로 ec2서버에 접속
git clone https://github.com/ksryong0/mypoll_chat.git
--------------------------------------------------------------------------
ls -al 명령어치면 나오는 출력 결과
drwxrwxr-x 10  ubuntu 		ubuntu 4096 Jan 26 06:21 mypoll_chat
d(디렉토리)	rwx(소유자) 	  rwx(소유자와 같은 그룹) 기타 	 만든사람의계정  그룹이름

r(read) w(write) x(excute)
그룹으로 묶는 이유:같이 설정해줘야되는게 생김. 하나의 부서 개념임.
---------------------------------------------------------------------------
ls -l : 파일에 대한 정보를 알려줌
ls -a : 숨김 파일을 보여줌(리눅스 숨김파일-파일명이 "."으로 시작)

vscode ssh로 접속한 상태에서 터미널

uv venv .venv --python 3.12
source .venv/bin/activate
uv pip install django django-bootstrap5 pillow langchain langchain-openai python-dotenv

sudo apt install -y build-essential pkg-config python3-dev libmariadb-dev libmariadb-dev-compat

python manage.py makemigrations
python manage.py migrate

개발 서버로 실행
python manage.py runserver 0.0.0.0:8000
13.209.219.255:8000

gunicorn?? WSGI 서버?웹어플리케이션 처리를 위한 무언가???
장고 뷰 실행해줌.

nginx 웹서버 설치(서비스 데몬 등록 및 실행)
sudo apt install nginx
y

(서비스)데몬:컴퓨터 부팅되면 자동으로 실행되는 프로그램
http://3.37.227.19/ (public ip) 로 접속해보면 잘 되는지 확인 가능.

nginx가 장고한테 시킬일이 있으면 gunicorn을 통해서 실행시키는 듯.

gunicorn 설치
uv pip install django gunicorn
----------------config/settings.py 수정------------------
host-서버
allowed_hosts = 호스트 이름을 뭐로 요청한 애만 허용하겠다. 실제 서비스에서는 등록한 도메인주소를 써둠.
생략하면 로컬호스트만 허용.

DEBUG = False 설정. True로 하면 에러메세지 볼 수 있음. 보통 개발중에 True로하고 배포시 False로 변경.

SECRET_KEY 도 원래 .env파일에 숨겨놔야됨.
SECRET_KEY = os.getenv("DJANGO_SECRET_KEY")

STATIC_ROOT 는 static 폴더를 외부로 뺄 거임.

STATIC_URL = '/static/'
STATIC_ROOT = '/var/www/mypoll_chat/static'
MEDIA_URL = '/media/'
MEDIA_ROOT = '/var/www/mypoll_chat/media'
-------------------터미널 명령----------------
STATIC_ROOT/MEDIA_ROOT 디렉토리 생성 + 소유권 변경 + 권한설정
sudo mkdir -p /var/www/mypoll_chat/static
sudo mkdir -p /var/www/mypoll_chat/media
-p : 해당디렉토리가 없으면 다 만들어라.
ls -l /var/www/mypoll_chat
하면 root로 되어있는듯.

디렉토리 소유권을 ubuntu로 변경
sudo chown ubuntu:ubuntu /var/www/mypoll_chat/static
sudo chown ubuntu:ubuntu /var/www/mypoll_chat/media
ls -l /var/www/mypoll_chat 하면
아까 root였던 애들이 ubuntu로 바뀜.

sudo chmod 755 /var/www/mypoll_chat/static
sudo chmod 755 /var/www/mypoll_chat/media
7: (rwx) 4 2 1
5: (r-x)

collectstatic 실행 - APP들에 나눠져있는 static 파일들을 static_root 경로로 이동
- python manage.py collectstatic
- 확인: ls /var/www/mypoll_chat/static

Gunicorn 실행
- mypoll_chat ROOT 디렉토리에서 실행
gunicorn --bind 0.0.0.0:8000 config.wsgi:application
http://3.37.227.19:8000/      (퍼블릭IP:8000)

git config user.name ksryong0
git config user.email ksryong0@gmail.com

장고app을 gunicorn이 실행. gunicorn은 view, template만 실행. static은 실행 안해줌.
이미지 파일을 받아와야됨.
static은 nginx가 서비스해야됨.
gunicorn은 장고만 실행. 뷰 이후만 실행.
그래서 웹서버 nginx랑 gunicorn을 연결해줘야됨.
----------------------------1월 27일------------------------------------
10. Gunicorn을 시스템 서비스 데몬으로 등록(부팅시 자동으로 실행되도록 설정)
- gunicorn + mypoll_chat application
- /etc/systemd/system 디렉토리 아래 service 설정파일을 저장.
 - /etc/systemd/system/mypoll_chat-wsgi.service 파일에 /mypoll_chat/aws_config/wsgi_conf.txt 내용을 저장
sudo nano /etc/systemd/system/mypoll_chat-wsgi.service 해서
/mypoll_chat/aws_config/wsgi_conf.txt 내용을 저장
-----------------
wsgi_conf.txt : 어떤 프로그램을 실행시켜 에 대한 설정.
description:설명
After=network.target : 네트워크가 활성화되면.

ExecStart=/home/ubuntu/mypoll_chat/.venv/bin/gunicorn --workers 3 --bind unix:/run/mypoll_chat/gunicorn.sock config.wsgi:application

/run/mypoll_chat/gunicorn.sock 라는 소켓파일을 실행.
뷰->nginx가 gunicorn에 요청. 그 때 소켓을 이용해 통신함. 그 소켓을 등록해둠.

RuntimeDirectory:런타임시 해당 디렉토리를 run밑에 만들어라. 이거 안하면 소켓이 안만들어짐.
RuntimeDirectoryMode : 권한은 755로 설정.
----------터미널에서------------
sudo nano /etc/systemd/system/mypoll_chat-wsgi.service
/mypoll_chat/aws_config/wsgi_conf.txt 에 있는 # 밑에 내용들을 복사해서 붙여넣기.
컨트롤 s, 컨트롤 x

서비스로 등록(서비스이름 : mypoll_chat-wsgi)
sudo systemctl start mypoll_chat-wsgi # 서비스 실행
sudo systemctl enable mypoll_chat-wsgi # 서비스 등록
sudo systemctl status mypoll_chat-wsgi # 서비스 상태 조회
q누르면 돌아옴

socket 파일 확인
ls -l /run/mypoll_chat

Nginx + gunicorn 연동 설정
- 사용자 요청에 따라서 어떻게 서비스 할지 설정.
- /static/ ==> STATIC_ROOT 경로 파일을 서비스
- /media/ ==> MEDIA_ROOT 경로 파일을 서비스
- 나머지 url요청 => gunicorn 호출
- nginx 설정파일에 위 내용을 설정 저장
- /etc/nginx/sites-available/mypoll_chat 파일에 "aws_config/nginx.txt"의 내용을 붙여넣기
sudo nano /etc/nginx/sites-available/mypoll_chat
server_name 뒤를 aws public IP로 변경

-------------nginx.txt 파일-------------
nginx.txt 파일에서 location은
http://ip/static/js/chat.js
static url이 들어오면 /var/www/mypoll_chat/static/ 밑에 js/chat.js로 가라는 의미
media도 같은 원리.

proxy_read_timeout 강제로 끊지말고 이 시간동안은 연결을 보장해줘.
----------------------------------------
심볼릭 링크(윈도우에서는 바로가기) 생성+nginx 재시작
sudo ln /etc/nginx/sites-available/mypoll_chat /etc/nginx/sites-enabled
ls -l /etc/nginx/sites-enabled
sudo nginx -t # NGINX 설정파일 검사
sudo systemctl restart nginx # 시스템 데몬 재시작
sudo systemctl status nginx # 시스템 데몬 실행상태 확인

----------------------nginx 설정, gunicorn 설정 변경, web application 코드 변경-----------------
sudo systemctl daemon-reload nginx 또는 mypoll_chat-wsgi
sudo systemctl restart nginx # nginx 설정 변경시
sudo systemctl restart mypoll_chat-wsgi # web app 코드 변경, gunicorn 서비스 설정 변경
sudo systemctl status nginx
sudo systemctl status mypoll_chat-wsgi
----------------------------------------------------





